services:
  postgres:
    profiles: [dev, staging, prod]
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-crypto_saas}
    ports: [ "5432:5432" ]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
  redis:
    profiles: [dev, staging, prod]
    image: redis:7
    ports: [ "6379:6379" ]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s
  backend:
    profiles: [dev, staging, prod]
    build: ./apps/backend
    environment:
      PORT: 8080
      QUANT_API_URL: http://quant:8001
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/crypto_saas
      REDIS_URL: redis://redis:6379
      JWT_PRIVATE_KEY_PATH: /home/cristian/p7-secrets/jwt_private.pem
      JWT_PUBLIC_KEY_PATH: /home/cristian/p7-secrets/jwt_public.pem
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
      quant:
        condition: service_healthy
    ports: [ "8080:8080" ]
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"require('http').get('http://localhost:8080/health', res => process.exit(res.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1));\"",
        ]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
  frontend:
    profiles: [dev, prod]
    build:
      context: ./apps/frontend
      dockerfile: Dockerfile
      args:
        - TS_BASE_PATH=../../tsconfig.base.json
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_BASE=http://backend:8080
    ports: [ "3000:3000" ]
    volumes:
      - ./apps/frontend:/app
      - ./apps/frontend/node_modules:/app/node_modules
      - ./tsconfig.base.json:/tsconfig.base.json:ro
      - /app/node_modules
      - /app/.next
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"require('http').get('http://localhost:3000', res => process.exit(res.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1));\"",
        ]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
  quant:
    profiles: [dev, staging, prod]
    build: ./services/quant
    ports: [ "8001:8001" ]
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python -c \"import sys, urllib.request; sys.exit(0) if urllib.request.urlopen('http://localhost:8001/health').status == 200 else sys.exit(1)\"",
        ]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
  grafana:
    profiles: [dev]
    image: grafana/grafana:11.2.0
    ports: [ "3001:3000" ]
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
  prometheus:
    profiles: [dev]
    image: prom/prometheus:v2.55.1
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports: [ "9090:9090" ]
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9090/-/healthy || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
  fm:
    profiles: [dev]
    build:
      context: ./services/fm/service
    env_file:
      - .env
    environment:
      - NODE_ENV=development
      - PORT=8080
    ports:
      - "8088:8080"
    networks:
      - default
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"require('http').get('http://localhost:8080/health', res => process.exit(res.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1));\"",
        ]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
